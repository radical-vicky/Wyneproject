{% extends "base.html" %}

{% block title %}Post - {{ post.user.username }} - CoopConnect{% endblock %}

{% block content %}
<div class="container">
    <!-- Post Card -->
    <div class="card mb-4">
        <!-- Header -->
        <div class="card-header bg-transparent">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <a href="{% url 'profile_view' username=post.user.username %}" 
                       class="text-decoration-none d-flex align-items-center">
                        {% if post.user.profile.photos.all %}
                        <img src="{{ post.user.profile.photos.first.image.url }}" 
                             alt="{{ post.user.username }}"
                             class="rounded-circle me-3" width="50" height="50"
                             style="object-fit: cover;">
                        {% else %}
                        <div class="rounded-circle bg-gradient me-3 d-flex align-items-center justify-content-center"
                             style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--coop-blue), var(--coop-green));">
                            <i class="fas fa-user text-light"></i>
                        </div>
                        {% endif %}
                        <div>
                            <h6 class="mb-0">{{ post.user.username }}</h6>
                            <small class="text-secondary">{{ post.created_at|timesince }} ago</small>
                        </div>
                    </a>
                </div>
                
                <!-- Dropdown -->
                {% if user == post.user or user.is_staff %}
                <div class="dropdown">
                    <button class="btn btn-sm btn-secondary dropdown-toggle" 
                            type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        {% if user == post.user %}
                        <li><a class="dropdown-item" href="#"><i class="fas fa-edit me-2"></i>Edit</a></li>
                        {% endif %}
                        <li>
                            <a class="dropdown-item" href="{% url 'post_archive' post_id=post.id %}">
                                <i class="fas fa-archive me-2"></i>
                                {% if post.is_archived %}Unarchive{% else %}Archive{% endif %}
                            </a>
                        </li>
                        {% if user == post.user or user.is_staff %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" 
                               href="{% url 'post_delete' post_id=post.id %}">
                                <i class="fas fa-trash me-2"></i>Delete
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Content -->
        <div class="card-body">
            <p class="mb-3">{{ post.content }}</p>
            
            <!-- Media -->
            {% if post.image %}
            <div class="mb-3">
                <img src="{{ post.image.url }}" alt="Post image" 
                     class="img-fluid rounded-lg">
            </div>
            {% elif post.video %}
            <div class="mb-3">
                <video controls class="img-fluid rounded-lg" poster="{{ post.video.thumbnail.url }}">
                    <source src="{{ post.video.video_file.url }}" type="video/mp4">
                </video>
            </div>
            {% endif %}
            
            <!-- Location -->
            {% if post.location %}
            <p class="text-secondary mb-0">
                <i class="fas fa-map-marker-alt me-2"></i>{{ post.location }}
            </p>
            {% endif %}
        </div>
        
        <!-- Stats -->
        <div class="card-footer bg-transparent">
            <div class="d-flex justify-content-between text-secondary">
                <div>
                    <span class="me-3">
                        <i class="fas fa-heart me-1"></i>
                        {{ post.likes }} likes
                    </span>
                    <span class="me-3">
                        <i class="fas fa-comment me-1"></i>
                        {{ post.comments_count }} comments
                    </span>
                    <span>
                        <i class="fas fa-eye me-1"></i>
                        {{ post.views }} views
                    </span>
                </div>
                <div>
                    <span>
                        <i class="fas fa-share me-1"></i>
                        {{ post.shares }} shares
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="card-footer bg-transparent">
            <div class="d-flex justify-content-around">
                <button class="btn btn-sm btn-outline-danger like-btn" 
                        data-post-id="{{ post.id }}"
                        data-liked="{% if 'like' in user_interactions %}true{% else %}false{% endif %}">
                    <i class="fas fa-heart me-2"></i>
                    <span class="like-text">
                        {% if 'like' in user_interactions %}Liked{% else %}Like{% endif %}
                    </span>
                </button>
                
                <button class="btn btn-sm btn-outline-secondary comment-btn" onclick="focusComment()">
                    <i class="fas fa-comment me-2"></i>Comment
                </button>
                
                <button class="btn btn-sm btn-outline-secondary share-btn" data-post-id="{{ post.id }}">
                    <i class="fas fa-share-alt me-2"></i>Share
                </button>
                
                <button class="btn btn-sm btn-outline-secondary save-btn"
                        data-post-id="{{ post.id }}"
                        data-saved="{% if 'save' in user_interactions %}true{% else %}false{% endif %}">
                    <i class="fas fa-bookmark me-2"></i>
                    <span class="save-text">
                        {% if 'save' in user_interactions %}Saved{% else %}Save{% endif %}
                    </span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Comments -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Comments ({{ comments.count }})</h5>
        </div>
        
        <div class="card-body">
            <!-- Add Comment -->
            <form method="POST" class="mb-4" id="commentForm">
                {% csrf_token %}
                <div class="d-flex align-items-start">
                    {% if user.profile.photos.all %}
                    <img src="{{ user.profile.photos.first.image.url }}" 
                         alt="{{ user.username }}"
                         class="rounded-circle me-3" width="40" height="40"
                         style="object-fit: cover;">
                    {% else %}
                    <div class="rounded-circle bg-gradient me-3 d-flex align-items-center justify-content-center"
                         style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--coop-blue), var(--coop-green));">
                        <i class="fas fa-user text-light"></i>
                    </div>
                    {% endif %}
                    <div class="flex-grow-1">
                        <textarea name="content" class="form-control" 
                                  rows="2" placeholder="Write a comment..." 
                                  required id="commentInput"></textarea>
                        <div class="text-end mt-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-2"></i>Post Comment
                            </button>
                        </div>
                    </div>
                </div>
            </form>
            
            <!-- Comments List -->
            <div class="comments-list">
                {% if comments %}
                {% for comment in comments %}
                <div class="comment-item mb-3 pb-3 border-bottom border-secondary">
                    <div class="d-flex">
                        <a href="{% url 'profile_view' username=comment.user.username %}"
                           class="text-decoration-none">
                            {% if comment.user.profile.photos.all %}
                            <img src="{{ comment.user.profile.photos.first.image.url }}" 
                                 alt="{{ comment.user.username }}"
                                 class="rounded-circle me-3" width="35" height="35"
                                 style="object-fit: cover;">
                            {% else %}
                            <div class="rounded-circle bg-gradient me-3 d-flex align-items-center justify-content-center"
                                 style="width: 35px; height: 35px; background: linear-gradient(135deg, var(--coop-blue), var(--coop-green));">
                                <i class="fas fa-user text-light"></i>
                            </div>
                            {% endif %}
                        </a>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="mb-0">{{ comment.user.username }}</h6>
                                    <small class="text-secondary">{{ comment.created_at|timesince }} ago</small>
                                </div>
                                {% if user == comment.user or user == post.user or user.is_staff %}
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-link text-secondary" 
                                            type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        {% if user == comment.user %}
                                        <li><a class="dropdown-item" href="#">Edit</a></li>
                                        {% endif %}
                                        <li>
                                            <a class="dropdown-item text-danger" 
                                               href="#" 
                                               onclick="return confirm('Delete this comment?')">
                                                Delete
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                            <p class="mb-0 mt-2">{{ comment.content }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-comment-slash fa-3x text-secondary mb-3"></i>
                    <p class="text-secondary">No comments yet. Be the first to comment!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Like functionality
    $('.like-btn').click(function() {
        const btn = $(this);
        const postId = btn.data('post-id');
        const isLiked = btn.data('liked') === 'true';
        
        $.ajax({
            url: '/post/' + postId + '/interact/like/',
            type: 'POST',
            headers: {
                'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
            },
            success: function(data) {
                if (data.success) {
                    btn.data('liked', !isLiked);
                    btn.find('.like-text').text(isLiked ? 'Like' : 'Liked');
                    if (isLiked) {
                        btn.removeClass('btn-danger').addClass('btn-outline-danger');
                    } else {
                        btn.removeClass('btn-outline-danger').addClass('btn-danger');
                    }
                }
            }
        });
    });
    
    // Save functionality
    $('.save-btn').click(function() {
        const btn = $(this);
        const postId = btn.data('post-id');
        const isSaved = btn.data('saved') === 'true';
        
        $.ajax({
            url: '/post/' + postId + '/interact/save/',
            type: 'POST',
            headers: {
                'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
            },
            success: function(data) {
                if (data.success) {
                    btn.data('saved', !isSaved);
                    btn.find('.save-text').text(isSaved ? 'Save' : 'Saved');
                    if (isSaved) {
                        btn.removeClass('btn-warning').addClass('btn-outline-secondary');
                    } else {
                        btn.removeClass('btn-outline-secondary').addClass('btn-warning');
                    }
                }
            }
        });
    });
    
    // Share functionality
    $('.share-btn').click(function() {
        const postId = $(this).data('post-id');
        const shareUrl = window.location.origin + '/post/' + postId + '/';
        
        if (navigator.share) {
            navigator.share({
                title: 'Check out this post on CoopConnect',
                url: shareUrl
            });
        } else {
            navigator.clipboard.writeText(shareUrl).then(function() {
                alert('Link copied to clipboard!');
            });
        }
    });
    
    // Comment form submission
    $('#commentForm').submit(function(e) {
        e.preventDefault();
        const form = $(this);
        const content = form.find('textarea').val();
        
        if (!content.trim()) return;
        
        $.ajax({
            url: window.location.href,
            type: 'POST',
            data: form.serialize(),
            success: function(data) {
                if (data.success) {
                    // Reload page to show new comment
                    location.reload();
                }
            }
        });
    });
    
    // Focus comment input
    window.focusComment = function() {
        $('#commentInput').focus();
    }
});
</script>
{% endblock %}