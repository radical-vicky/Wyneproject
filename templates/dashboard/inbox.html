{% extends 'base.html' %}

{% block title %}Messages - CoopConnect Premium{% endblock %}

{% block extra_css %}
<style>
.inbox-container {
    display: flex;
    gap: 20px;
    height: calc(100vh - 200px);
}

.conversations-sidebar {
    width: 350px;
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: 20px;
    border: 1px solid var(--border-color);
    overflow-y: auto;
}

.conversation-detail {
    flex: 1;
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.new-conversation-btn {
    width: 100%;
    margin-bottom: 20px;
}

.conversation-search {
    margin-bottom: 20px;
}

.conversation-list {
    max-height: calc(100vh - 300px);
    overflow-y: auto;
}

.conversation-item {
    padding: 15px;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 1px solid var(--border-color);
}

.conversation-item:hover {
    background: rgba(255,255,255,0.05);
}

.conversation-item.active {
    background: rgba(0,168,89,0.1);
    border-left: 3px solid var(--coop-green);
}

.conversation-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 15px;
}

.conversation-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.conversation-info {
    flex: 1;
}

.conversation-name {
    font-weight: 600;
    margin-bottom: 5px;
}

.conversation-preview {
    color: var(--text-secondary);
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.conversation-time {
    color: var(--text-muted);
    font-size: 0.8rem;
}

.unread-badge {
    background: var(--coop-green);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: 600;
    min-width: 20px;
    text-align: center;
}

.message-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    background: var(--darker-bg);
}

.message-participants {
    display: flex;
    align-items: center;
    gap: 10px;
}

.message-actions {
    display: flex;
    gap: 10px;
}

.messages-container {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 15px;
    border-radius: 18px;
    position: relative;
}

.message-bubble.sent {
    background: var(--coop-green);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 5px;
}

.message-bubble.received {
    background: var(--darker-bg);
    color: var(--text-primary);
    align-self: flex-start;
    border-bottom-left-radius: 5px;
}

.message-time {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 5px;
    text-align: right;
}

.message-input-container {
    padding: 20px;
    border-top: 1px solid var(--border-color);
    background: var(--darker-bg);
}

.message-input-wrapper {
    display: flex;
    gap: 10px;
    align-items: center;
}

.message-input {
    flex: 1;
    padding: 12px 15px;
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    color: var(--text-primary);
    font-size: 0.95rem;
    resize: none;
    min-height: 50px;
    max-height: 120px;
}

.message-input:focus {
    outline: none;
    border-color: var(--coop-green);
}

.attachment-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 1.2rem;
    cursor: pointer;
    padding: 10px;
    border-radius: var(--radius);
    transition: all 0.3s ease;
}

.attachment-btn:hover {
    background: rgba(255,255,255,0.05);
    color: var(--text-primary);
}

.send-btn {
    padding: 12px 25px;
}

.media-attachment {
    margin-top: 10px;
}

.attachment-preview {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: rgba(255,255,255,0.05);
    padding: 8px 12px;
    border-radius: var(--radius);
}

.remove-attachment {
    background: none;
    border: none;
    color: var(--danger);
    cursor: pointer;
    padding: 0;
}

.empty-state {
    text-align: center;
    padding: 50px 20px;
    color: var(--text-secondary);
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.typing-indicator {
    display: flex;
    gap: 5px;
    padding: 10px 15px;
    background: var(--darker-bg);
    border-radius: 18px;
    width: fit-content;
    margin-bottom: 10px;
    align-self: flex-start;
}

.typing-dot {
    width: 8px;
    height: 8px;
    background: var(--text-secondary);
    border-radius: 50%;
    animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
    }
    30% {
        transform: translateY(-5px);
        opacity: 1;
    }
}

@media (max-width: 992px) {
    .inbox-container {
        flex-direction: column;
        height: auto;
    }
    
    .conversations-sidebar {
        width: 100%;
        max-height: 400px;
    }
    
    .conversation-list {
        max-height: 300px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header">
        <h1 class="card-title">Messages</h1>
        <p class="card-subtitle">Connect and chat with other members</p>
    </div>
</div>

<div class="inbox-container">
    <!-- Conversations Sidebar -->
    <div class="conversations-sidebar">
        <button class="btn btn-primary new-conversation-btn" onclick="startNewConversation()">
            <i class="fas fa-plus"></i> New Conversation
        </button>
        
        <div class="conversation-search">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search conversations...">
            </div>
        </div>
        
        <div class="conversation-list">
            {% for conversation in conversations %}
            <div class="conversation-item d-flex align-center {% if conversation.id == active_conversation.id %}active{% endif %}" 
                 onclick="loadConversation('{{ conversation.id }}')">
                <div class="conversation-avatar">
                    {% if conversation.other_profile.photos.first %}
                    <img src="{{ conversation.other_profile.photos.first.image.url }}" alt="{{ conversation.other_participant.username }}">
                    {% else %}
                    <div class="d-flex align-center justify-center h-100" style="background: var(--coop-green);">
                        <i class="fas fa-user"></i>
                    </div>
                    {% endif %}
                </div>
                
                <div class="conversation-info">
                    <div class="d-flex justify-between align-center">
                        <div class="conversation-name">{{ conversation.other_participant.username }}</div>
                        <div class="conversation-time">{{ conversation.last_message_at|timesince }} ago</div>
                    </div>
                    <div class="conversation-preview">{{ conversation.last_message|truncatechars:50 }}</div>
                </div>
                
                {% if conversation.unread_count > 0 %}
                <div class="unread-badge">{{ conversation.unread_count }}</div>
                {% endif %}
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <h4>No conversations yet</h4>
                <p>Start a conversation with other members</p>
                <button class="btn btn-primary mt-3" onclick="startNewConversation()">
                    <i class="fas fa-plus"></i> Start Chatting
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Conversation Detail -->
    <div class="conversation-detail" id="conversationDetail">
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-comment-alt"></i>
            </div>
            <h4>Select a conversation</h4>
            <p>Choose a conversation from the sidebar or start a new one</p>
        </div>
    </div>
</div>

<!-- New Conversation Modal -->
<div class="modal" id="newConversationModal">
    <div class="modal-content">
        <button class="modal-close" onclick="hideModal()">
            <i class="fas fa-times"></i>
        </button>
        <h3 class="card-title mb-3">New Conversation</h3>
        
        <div class="form-group">
            <label class="form-label">Search Users</label>
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="userSearch" placeholder="Search by username...">
            </div>
            <div id="searchResults" class="mt-3" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
        
        <div class="form-group mt-4">
            <label class="form-label">Initial Message (Optional)</label>
            <textarea class="form-control" id="initialMessage" rows="3" placeholder="Type your message..."></textarea>
        </div>
        
        <div class="d-flex gap-3 mt-4">
            <button class="btn btn-primary" onclick="createConversation()">Start Conversation</button>
            <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Load first conversation if available
    {% if conversations %}
        loadConversation('{{ conversations.0.id }}');
    {% endif %}
    
    // Search conversations
    $('.conversation-search input').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('.conversation-item').each(function() {
            const name = $(this).find('.conversation-name').text().toLowerCase();
            const preview = $(this).find('.conversation-preview').text().toLowerCase();
            
            if (name.includes(searchTerm) || preview.includes(searchTerm)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
    
    // Search users for new conversation
    $('#userSearch').on('input', function() {
        const query = $(this).val();
        
        if (query.length >= 2) {
            $.ajax({
                url: '{% url "api_search_users" %}',
                method: 'GET',
                data: { q: query },
                success: function(response) {
                    displaySearchResults(response.users);
                }
            });
        } else {
            $('#searchResults').empty();
        }
    });
    
    let selectedUser = null;
    
    function displaySearchResults(users) {
        const resultsContainer = $('#searchResults');
        resultsContainer.empty();
        
        if (users.length === 0) {
            resultsContainer.html('<div class="text-center text-secondary p-3">No users found</div>');
            return;
        }
        
        users.forEach(user => {
            const userElement = $(`
                <div class="user-result d-flex align-center gap-3 p-3 rounded" 
                     style="cursor: pointer; background: rgba(255,255,255,0.02); margin-bottom: 5px;"
                     onclick="selectUser('${user.username}')">
                    <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden;">
                        ${user.avatar_url ? 
                          `<img src="${user.avatar_url}" alt="${user.username}" style="width: 100%; height: 100%; object-fit: cover;">` :
                          `<div class="d-flex align-center justify-center h-100" style="background: var(--coop-green);">
                               <i class="fas fa-user"></i>
                           </div>`
                        }
                    </div>
                    <div>
                        <div class="text-primary">${user.username}</div>
                        <div class="text-secondary text-sm">${user.city_town || 'Location not set'}</div>
                    </div>
                    ${user.is_online ? '<span class="status-dot online ml-auto"></span>' : ''}
                </div>
            `);
            
            resultsContainer.append(userElement);
        });
    }
});

function startNewConversation() {
    selectedUser = null;
    $('#userSearch').val('');
    $('#initialMessage').val('');
    $('#searchResults').empty();
    showModal($('#newConversationModal').html());
}

function selectUser(username) {
    selectedUser = username;
    $('#userSearch').val(username);
    $('#searchResults').html(`
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            Selected: <strong>${username}</strong>
        </div>
    `);
}

function createConversation() {
    if (!selectedUser) {
        alert('Please select a user to start a conversation');
        return;
    }
    
    const message = $('#initialMessage').val();
    
    $.ajax({
        url: '{% url "conversation_new" %}',
        method: 'POST',
        data: {
            username: selectedUser,
            initial_message: message,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                hideModal();
                loadConversation(response.conversation_id);
            } else {
                alert(response.error || 'Could not create conversation');
            }
        },
        error: function() {
            alert('An error occurred. Please try again.');
        }
    });
}

function loadConversation(conversationId) {
    $.ajax({
        url: `/conversation/${conversationId}/`,
        method: 'GET',
        success: function(response) {
            $('#conversationDetail').html(response);
            
            // Mark conversation as active in sidebar
            $('.conversation-item').removeClass('active');
            $(`.conversation-item[onclick*="${conversationId}"]`).addClass('active');
            
            // Scroll to bottom of messages
            const messagesContainer = $('#messagesContainer');
            if (messagesContainer.length) {
                messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
            }
        }
    });
}

// Message sending functionality
function sendMessage() {
    const input = $('#messageInput');
    const message = input.val().trim();
    
    if (!message) return;
    
    // Add message to UI immediately
    const messageElement = $(`
        <div class="message-bubble sent">
            <div class="message-content">${message}</div>
            <div class="message-time">Just now</div>
        </div>
    `);
    
    $('#messagesContainer').append(messageElement);
    input.val('');
    
    // Scroll to bottom
    $('#messagesContainer').scrollTop($('#messagesContainer')[0].scrollHeight);
    
    // Send to server
    $.ajax({
        url: window.location.pathname,
        method: 'POST',
        data: {
            content: message,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
            // Update message ID if needed
            if (response.message_id) {
                messageElement.data('message-id', response.message_id);
            }
        }
    });
}

// Typing indicator
let typingTimeout;
function showTypingIndicator() {
    clearTimeout(typingTimeout);
    
    // Show typing indicator
    const indicator = $('#typingIndicator');
    if (indicator.length === 0) {
        const typingElement = $(`
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        `);
        $('#messagesContainer').append(typingElement);
    }
    
    // Hide after 3 seconds of no typing
    typingTimeout = setTimeout(() => {
        $('#typingIndicator').remove();
    }, 3000);
}

// Real-time updates (using polling for simplicity)
function pollMessages() {
    const lastMessageId = $('#messagesContainer .message-bubble:last').data('message-id') || 0;
    
    $.ajax({
        url: `{% url 'api_conversation_messages' 0 %}`.replace('0', $('#conversationId').val()),
        method: 'GET',
        data: { last_message_id: lastMessageId },
        success: function(response) {
            if (response.messages.length > 0) {
                response.messages.forEach(message => {
                    const messageClass = message.sender === '{{ request.user.username }}' ? 'sent' : 'received';
                    const messageElement = $(`
                        <div class="message-bubble ${messageClass}" data-message-id="${message.id}">
                            <div class="message-content">${message.content}</div>
                            <div class="message-time">${message.sent_at}</div>
                        </div>
                    `);
                    $('#messagesContainer').append(messageElement);
                });
                
                // Scroll to bottom
                $('#messagesContainer').scrollTop($('#messagesContainer')[0].scrollHeight);
            }
        }
    });
}

// Poll every 5 seconds
setInterval(pollMessages, 5000);
</script>
{% endblock %}