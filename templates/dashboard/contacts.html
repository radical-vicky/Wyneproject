{% extends 'base.html' %}

{% block title %}Contacts - CoopConnect Premium{% endblock %}

{% block extra_css %}
<style>
/* Contacts specific styles */
.contacts-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.contacts-filter {
    display: flex;
    gap: 15px;
    margin-bottom: 25px;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 8px 20px;
    background: var(--darker-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.filter-btn:hover {
    background: rgba(255,255,255,0.05);
    color: var(--text-primary);
}

.filter-btn.active {
    background: var(--coop-green);
    color: white;
    border-color: var(--coop-green);
}

.contact-card {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: 20px;
    border: 1px solid var(--border-color);
    margin-bottom: 20px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 20px;
}

.contact-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow);
    border-color: var(--coop-green);
}

.contact-avatar {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid var(--coop-green);
    flex-shrink: 0;
}

.contact-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.contact-info {
    flex: 1;
}

.contact-name {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.contact-meta {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: 10px;
}

.contact-location {
    display: flex;
    align-items: center;
    gap: 5px;
}

.contact-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.contact-status {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.85rem;
    padding: 4px 10px;
    border-radius: 12px;
    background: rgba(255,255,255,0.05);
}

.status-online {
    color: var(--success);
}

.status-offline {
    color: var(--text-muted);
}

.favorite-star {
    color: #ffc107;
    font-size: 1.1rem;
}

.contact-tags {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
}

.contact-tag {
    background: rgba(0,168,89,0.1);
    color: var(--coop-green);
    padding: 3px 10px;
    border-radius: 15px;
    font-size: 0.8rem;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-icon {
    font-size: 4rem;
    color: var(--text-muted);
    margin-bottom: 20px;
}

/* Add Contact Modal */
.modal-content {
    max-width: 600px;
}

.add-contact-form .form-group {
    margin-bottom: 20px;
}

.search-results {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 15px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 10px;
}

.search-result-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px;
    border-radius: var(--radius);
    cursor: pointer;
    transition: background 0.3s ease;
}

.search-result-item:hover {
    background: rgba(255,255,255,0.05);
}

.search-result-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
}

.search-result-info {
    flex: 1;
}

.search-result-name {
    font-weight: 500;
}

.search-result-meta {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .contact-card {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .contact-info {
        width: 100%;
    }
    
    .contact-actions {
        justify-content: center;
        width: 100%;
    }
    
    .contacts-filter {
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="contacts-header">
    <div>
        <h1 class="card-title">Contacts</h1>
        <p class="card-subtitle">Manage your connections and favorite contacts</p>
    </div>
    <button class="btn btn-primary" id="addContactBtn">
        <i class="fas fa-user-plus"></i> Add Contact
    </button>
</div>

<!-- Contacts Filter -->
<div class="contacts-filter">
    <button class="filter-btn active" data-filter="all">All Contacts</button>
    <button class="filter-btn" data-filter="favorites">
        <i class="fas fa-star"></i> Favorites
    </button>
    <button class="filter-btn" data-filter="online">Online Now</button>
    <button class="filter-btn" data-filter="recent">Recently Added</button>
    <button class="filter-btn" data-filter="blocked">Blocked</button>
</div>

<!-- Contacts List -->
<div class="contacts-list">
    {% if contacts %}
        {% for contact in contacts %}
        <div class="contact-card" data-filter="{% if contact.is_favorite %}favorites{% endif %} {% if contact.contact_user.profile.is_online %}online{% endif %}">
            <div class="contact-avatar">
                {% if contact.contact_user.profile.photos.first %}
                <img src="{{ contact.contact_user.profile.photos.first.image.url }}" alt="{{ contact.contact_user.username }}">
                {% else %}
                <div class="d-flex align-center justify-center h-100" style="background: var(--primary-gradient);">
                    <i class="fas fa-user fa-lg"></i>
                </div>
                {% endif %}
            </div>
            
            <div class="contact-info">
                <div class="contact-name">
                    {% if contact.nickname %}
                        {{ contact.nickname }}
                        <span class="text-secondary" style="font-weight: normal;">(@{{ contact.contact_user.username }})</span>
                    {% else %}
                        {{ contact.contact_user.username }}
                    {% endif %}
                    
                    {% if contact.is_favorite %}
                    <i class="fas fa-star favorite-star"></i>
                    {% endif %}
                    
                    {% if contact.is_blocked %}
                    <span class="badge badge-danger ml-2">Blocked</span>
                    {% endif %}
                </div>
                
                <div class="contact-meta">
                    <div class="contact-location">
                        <i class="fas fa-map-marker-alt"></i>
                        {{ contact.contact_user.profile.city_town|default:"Unknown location" }}
                    </div>
                    
                    <div class="contact-status">
                        <span class="status-dot {% if contact.contact_user.profile.is_online %}online{% else %}offline{% endif %}"></span>
                        <span>{% if contact.contact_user.profile.is_online %}Online{% else %}Offline - Last seen {{ contact.contact_user.profile.last_active|timesince }} ago{% endif %}</span>
                    </div>
                </div>
                
                {% if contact.contact_user.profile.services_offered %}
                <div class="contact-tags">
                    {% for service in contact.contact_user.profile.get_services_list|slice:":3" %}
                    <span class="contact-tag">{{ service }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            <div class="contact-actions">
                {% if not contact.is_blocked %}
                <a href="{% url 'conversation_user' contact.contact_user.username %}" class="btn btn-primary btn-sm">
                    <i class="fas fa-comment"></i> Message
                </a>
                <a href="{% url 'call_initiate' contact.contact_user.username %}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-phone"></i> Call
                </a>
                <a href="{% url 'profile_view' contact.contact_user.username %}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-eye"></i> View Profile
                </a>
                {% endif %}
                
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="dropdown-menu" style="background: var(--darker-bg); border: 1px solid var(--border-color);">
                        <a class="dropdown-item" href="#" onclick="toggleFavorite({{ contact.id }})">
                            {% if contact.is_favorite %}
                            <i class="fas fa-star text-warning"></i> Remove from Favorites
                            {% else %}
                            <i class="far fa-star"></i> Add to Favorites
                            {% endif %}
                        </a>
                        
                        {% if contact.is_blocked %}
                        <a class="dropdown-item" href="#" onclick="toggleBlock({{ contact.id }})">
                            <i class="fas fa-user-check"></i> Unblock Contact
                        </a>
                        {% else %}
                        <a class="dropdown-item" href="#" onclick="toggleBlock({{ contact.id }})">
                            <i class="fas fa-user-slash text-danger"></i> Block Contact
                        </a>
                        {% endif %}
                        
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="#" onclick="deleteContact({{ contact.id }})">
                            <i class="fas fa-trash"></i> Delete Contact
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-users"></i>
            </div>
            <h3 class="mb-2">No Contacts Yet</h3>
            <p class="text-secondary mb-4">Start building your network by adding contacts from user profiles</p>
            <button class="btn btn-primary" id="addContactBtn2">
                <i class="fas fa-user-plus"></i> Add Your First Contact
            </button>
        </div>
    {% endif %}
</div>

<!-- Pagination -->
{% if contacts.has_other_pages %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if contacts.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ contacts.previous_page_number }}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        {% endif %}
        
        {% for i in contacts.paginator.page_range %}
        {% if contacts.number == i %}
        <li class="page-item active">
            <span class="page-link">{{ i }}</span>
        </li>
        {% else %}
        <li class="page-item">
            <a class="page-link" href="?page={{ i }}">{{ i }}</a>
        </li>
        {% endif %}
        {% endfor %}
        
        {% if contacts.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ contacts.next_page_number }}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<script>
$(document).ready(function() {
    // Filter functionality
    $('.filter-btn').click(function() {
        $('.filter-btn').removeClass('active');
        $(this).addClass('active');
        
        const filter = $(this).data('filter');
        $('.contact-card').show();
        
        if (filter !== 'all') {
            $('.contact-card').each(function() {
                const filters = $(this).data('filter').split(' ');
                if (!filters.includes(filter)) {
                    $(this).hide();
                }
            });
        }
    });
    
    // Add Contact Modal
    function showAddContactModal() {
        showModal(`
            <div class="add-contact-form">
                <h3 class="card-title mb-3">Add New Contact</h3>
                <form id="addContactForm">
                    <div class="form-group">
                        <label class="form-label">Search by Username, Email, or Phone</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchContact" placeholder="Enter username, email, or phone number" autocomplete="off">
                            <button class="btn btn-primary" type="button" id="searchContactBtn">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                        <div id="searchResults" class="search-results"></div>
                    </div>
                    
                    <div class="form-group" id="contactDetails" style="display: none;">
                        <div class="card p-3 mb-3">
                            <div class="d-flex align-center gap-3 mb-3">
                                <div class="contact-avatar" id="selectedAvatar" style="width: 50px; height: 50px;"></div>
                                <div id="selectedUserInfo"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Nickname (Optional)</label>
                            <input type="text" class="form-control" id="contactNickname" placeholder="Enter nickname for this contact">
                        </div>
                        
                        <div class="d-flex gap-3">
                            <button type="submit" class="btn btn-primary flex-1">
                                <i class="fas fa-user-plus"></i> Add Contact
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="hideModal()">Cancel</button>
                        </div>
                    </div>
                </form>
            </div>
        `);
        
        // Search functionality
        $('#searchContactBtn').click(searchUsers);
        $('#searchContact').on('keyup', function(e) {
            if (e.key === 'Enter') searchUsers();
        });
    }
    
    function searchUsers() {
        const query = $('#searchContact').val().trim();
        if (query.length < 2) {
            $('#searchResults').html('<div class="text-center p-3 text-secondary">Enter at least 2 characters to search</div>');
            return;
        }
        
        $('#searchResults').html('<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Searching...</div>');
        
        $.ajax({
            url: '{% url "api_search_users" %}',
            method: 'GET',
            data: { q: query },
            success: function(response) {
                if (response.users && response.users.length > 0) {
                    let html = '';
                    response.users.forEach(function(user) {
                        html += `
                            <div class="search-result-item" data-user-id="${user.id}">
                                <div class="search-result-avatar">
                                    ${user.avatar_url ? 
                                        `<img src="${user.avatar_url}" alt="${user.username}">` :
                                        `<div class="d-flex align-center justify-center h-100" style="background: var(--primary-gradient);">
                                            <i class="fas fa-user"></i>
                                        </div>`
                                    }
                                </div>
                                <div class="search-result-info">
                                    <div class="search-result-name">${user.username}</div>
                                    <div class="search-result-meta">
                                        ${user.city_town || 'Unknown location'} â€¢ ${user.is_online ? 'Online' : 'Offline'}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    $('#searchResults').html(html);
                    
                    // Add click handler for search results
                    $('.search-result-item').click(function() {
                        const userId = $(this).data('user-id');
                        const user = response.users.find(u => u.id == userId);
                        selectUser(user);
                    });
                } else {
                    $('#searchResults').html('<div class="text-center p-3 text-secondary">No users found</div>');
                }
            },
            error: function() {
                $('#searchResults').html('<div class="text-center p-3 text-danger">Error searching for users</div>');
            }
        });
    }
    
    function selectUser(user) {
        $('#contactDetails').show();
        $('#selectedUserInfo').html(`
            <div>
                <strong>${user.username}</strong>
                <div class="text-secondary text-sm">${user.email}</div>
                <div class="text-secondary text-sm">${user.city_town || 'Unknown location'}</div>
            </div>
        `);
        
        if (user.avatar_url) {
            $('#selectedAvatar').html(`<img src="${user.avatar_url}" alt="${user.username}">`);
        } else {
            $('#selectedAvatar').html(`
                <div class="d-flex align-center justify-center h-100" style="background: var(--primary-gradient);">
                    <i class="fas fa-user"></i>
                </div>
            `);
        }
        
        // Store selected user in form
        $('#addContactForm').data('selected-user', user);
    }
    
    // Handle add contact form submission
    $('#addContactBtn, #addContactBtn2').click(showAddContactModal);
    
    $(document).on('submit', '#addContactForm', function(e) {
        e.preventDefault();
        const user = $(this).data('selected-user');
        const nickname = $('#contactNickname').val().trim();
        
        if (!user) {
            alert('Please select a user first');
            return;
        }
        
        $.ajax({
            url: '{% url "contact_add" %}',
            method: 'POST',
            data: {
                username: user.username,
                nickname: nickname || user.username
            },
            headers: {
                'X-CSRFToken': $('meta[name="csrf-token"]').attr('content'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.success) {
                    showModal(`
                        <div class="text-center p-4">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <h3>Contact Added!</h3>
                            <p>${response.message}</p>
                            <button class="btn btn-primary mt-3" onclick="location.reload()">OK</button>
                        </div>
                    `);
                } else {
                    showModal(`
                        <div class="text-center p-4">
                            <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
                            <h3>Error</h3>
                            <p>${response.error}</p>
                            <button class="btn btn-primary mt-3" onclick="hideModal()">OK</button>
                        </div>
                    `);
                }
            },
            error: function() {
                showModal(`
                    <div class="text-center p-4">
                        <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
                        <h3>Error</h3>
                        <p>Failed to add contact. Please try again.</p>
                        <button class="btn btn-primary mt-3" onclick="hideModal()">OK</button>
                    </div>
                `);
            }
        });
    });
    
    // Contact actions
    window.toggleFavorite = function(contactId) {
        $.ajax({
            url: '{% url "contact_toggle_favorite" 999999999 %}'.replace('999999999', contactId),
            method: 'POST',
            headers: {
                'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
            },
            success: function() {
                location.reload();
            }
        });
    };
    
    window.toggleBlock = function(contactId) {
        $.ajax({
            url: '{% url "contact_block" 999999999 %}'.replace('999999999', contactId),
            method: 'POST',
            headers: {
                'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
            },
            success: function() {
                location.reload();
            }
        });
    };
    
    window.deleteContact = function(contactId) {
        showModal(`
            <div class="text-center p-4">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h3>Delete Contact</h3>
                <p>Are you sure you want to delete this contact? This action cannot be undone.</p>
                <div class="d-flex gap-3 mt-4">
                    <button class="btn btn-danger flex-1" onclick="confirmDelete(${contactId})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    <button class="btn btn-secondary flex-1" onclick="hideModal()">Cancel</button>
                </div>
            </div>
        `);
    };
    
    window.confirmDelete = function(contactId) {
        $.ajax({
            url: '{% url "contact_delete" 999999999 %}'.replace('999999999', contactId),
            method: 'POST',
            headers: {
                'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
            },
            success: function() {
                location.reload();
            }
        });
    };
});
</script>
{% endblock %}