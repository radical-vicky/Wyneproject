{% extends 'base.html' %}

{% block title %}Saved Searches - CoopConnect Premium{% endblock %}

{% block extra_css %}
<style>
/* Saved Searches specific styles */
.saved-searches-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.search-card {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: 25px;
    border: 1px solid var(--border-color);
    margin-bottom: 20px;
    transition: all 0.3s ease;
    position: relative;
}

.search-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow);
    border-color: var(--coop-green);
}

.search-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.search-info {
    flex: 1;
}

.search-title {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--text-primary);
}

.search-query {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 10px;
    word-break: break-word;
}

.search-meta {
    display: flex;
    gap: 15px;
    font-size: 0.85rem;
    color: var(--text-muted);
}

.search-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
}

.filter-tag {
    background: rgba(0,168,89,0.1);
    color: var(--coop-green);
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.85rem;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.filter-tag i {
    font-size: 0.8rem;
}

.search-results-count {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-top: 10px;
}

.search-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
}

.search-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-recent {
    background: rgba(33, 150, 243, 0.2);
    color: var(--info);
}

.badge-popular {
    background: rgba(156, 39, 176, 0.2);
    color: #9c27b0;
}

.badge-custom {
    background: rgba(255, 193, 7, 0.2);
    color: var(--warning);
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-icon {
    font-size: 4rem;
    color: var(--text-muted);
    margin-bottom: 20px;
}

/* Filter section */
.filter-section {
    background: var(--darker-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 25px;
}

.filter-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 15px;
    color: var(--text-primary);
}

.filter-options {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.filter-option {
    padding: 8px 16px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.filter-option:hover {
    background: rgba(255,255,255,0.05);
    color: var(--text-primary);
}

.filter-option.active {
    background: var(--coop-green);
    color: white;
    border-color: var(--coop-green);
}

/* Saved search form */
.saved-search-form {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: 25px;
    margin-bottom: 30px;
    border: 1px solid var(--border-color);
}

.form-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 20px;
    color: var(--text-primary);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .search-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .search-actions {
        flex-direction: column;
    }
    
    .search-actions .btn {
        width: 100%;
        justify-content: center;
    }
    
    .filter-options {
        flex-direction: column;
    }
    
    .filter-option {
        width: 100%;
        text-align: center;
    }
}

/* Statistics */
.search-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    text-align: center;
    border: 1px solid var(--border-color);
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-icon {
    font-size: 2rem;
    color: var(--coop-green);
    margin-bottom: 10px;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<div class="saved-searches-header">
    <div>
        <h1 class="card-title">Saved Searches</h1>
        <p class="card-subtitle">Quickly access your frequently used search filters</p>
    </div>
    <button class="btn btn-primary" id="saveCurrentSearchBtn">
        <i class="fas fa-plus-circle"></i> Save Current Search
    </button>
</div>

<!-- Statistics -->
<div class="search-stats">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-bookmark"></i>
        </div>
        <div class="stat-number">{{ total_searches|default:"0" }}</div>
        <div class="stat-label">Total Saved Searches</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-fire"></i>
        </div>
        <div class="stat-number">{{ active_searches|default:"0" }}</div>
        <div class="stat-label">Active Searches</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-number">{{ total_results|default:"0" }}</div>
        <div class="stat-label">Total Results Found</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-number">{{ recent_searches|default:"0" }}</div>
        <div class="stat-label">Recent (Last 7 days)</div>
    </div>
</div>

<!-- Filter Section -->
<div class="filter-section">
    <div class="filter-title">Filter Saved Searches</div>
    <div class="filter-options">
        <button class="filter-option active" data-filter="all">All Searches</button>
        <button class="filter-option" data-filter="recent">Recently Used</button>
        <button class="filter-option" data-filter="favorites">Favorites</button>
        <button class="filter-option" data-filter="with_results">With Results</button>
        <button class="filter-option" data-filter="no_results">No Results</button>
        <button class="filter-option" data-filter="custom">Custom Filters</button>
    </div>
</div>

<!-- Save Current Search Form (Initially hidden) -->
<div class="saved-search-form" id="saveSearchForm" style="display: none;">
    <div class="form-title">Save Current Search</div>
    <form id="saveSearchFormContent">
        <div class="form-group mb-3">
            <label class="form-label">Search Name</label>
            <input type="text" class="form-control" id="searchName" placeholder="e.g., Nairobi VIP Services" required>
            <div class="text-sm text-secondary mt-1">Give your search a descriptive name</div>
        </div>
        
        <div class="form-group mb-3">
            <label class="form-label">Search Query</label>
            <input type="text" class="form-control" id="searchQuery" placeholder="e.g., dinner date, massage" readonly>
            <div class="text-sm text-secondary mt-1">Current search terms (from URL)</div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">Filters Applied</label>
                    <div id="currentFilters" class="p-3 rounded" style="background: rgba(255,255,255,0.05); min-height: 100px;">
                        <!-- Filters will be populated here -->
                        <div class="text-secondary">No filters detected from current search</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">Additional Notes (Optional)</label>
                    <textarea class="form-control" id="searchNotes" rows="4" placeholder="Add any notes about this search..."></textarea>
                </div>
            </div>
        </div>
        
        <div class="form-group mb-3">
            <label class="form-label">
                <input type="checkbox" id="markFavorite" class="mr-2">
                Mark as Favorite
            </label>
        </div>
        
        <div class="d-flex gap-3">
            <button type="submit" class="btn btn-primary flex-1">
                <i class="fas fa-save"></i> Save Search
            </button>
            <button type="button" class="btn btn-secondary" onclick="hideSaveForm()">
                Cancel
            </button>
        </div>
    </form>
</div>

<!-- Saved Searches List -->
<div class="saved-searches-list">
    {% if saved_searches %}
        {% for search in saved_searches %}
        <div class="search-card" data-category="{% if search.is_favorite %}favorites{% endif %} {% if search.last_used %}recent{% endif %}">
            <div class="search-header">
                <div class="search-info">
                    <div class="search-title">
                        {{ search.name|default:"Unnamed Search" }}
                        {% if search.is_favorite %}
                        <i class="fas fa-star text-warning ml-2"></i>
                        {% endif %}
                        
                        {% if search.search_query %}
                        <span class="search-badge badge-custom ml-2">Custom</span>
                        {% endif %}
                    </div>
                    
                    {% if search.search_query %}
                    <div class="search-query">
                        <i class="fas fa-search text-secondary"></i>
                        "{{ search.search_query }}"
                    </div>
                    {% endif %}
                    
                    <div class="search-meta">
                        <span>
                            <i class="far fa-calendar"></i>
                            Saved {{ search.created_at|date:"M d, Y" }}
                        </span>
                        
                        {% if search.last_used %}
                        <span>
                            <i class="far fa-clock"></i>
                            Last used {{ search.last_used|date:"M d, Y" }}
                        </span>
                        {% endif %}
                        
                        <span>
                            <i class="fas fa-redo"></i>
                            Used {{ search.use_count|default:"0" }} times
                        </span>
                    </div>
                    
                    {% if search.filters %}
                    <div class="search-filters">
                        {% for key, value in search.filters.items %}
                        {% if value %}
                        <span class="filter-tag">
                            {% if key == 'gender' %}
                            <i class="fas fa-venus-mars"></i>
                            {% elif key == 'county' %}
                            <i class="fas fa-map-marker-alt"></i>
                            {% elif key == 'min_age' or key == 'max_age' %}
                            <i class="fas fa-birthday-cake"></i>
                            {% elif key == 'services' %}
                            <i class="fas fa-concierge-bell"></i>
                            {% elif key == 'is_vip' %}
                            <i class="fas fa-crown"></i>
                            {% else %}
                            <i class="fas fa-filter"></i>
                            {% endif %}
                            
                            {{ key }}: {{ value }}
                        </span>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    {% if search.results_count %}
                    <div class="search-results-count">
                        <i class="fas fa-users"></i>
                        Found {{ search.results_count }} profiles
                    </div>
                    {% endif %}
                    
                    {% if search.notes %}
                    <div class="mt-3 p-3 rounded" style="background: rgba(255,255,255,0.03);">
                        <div class="text-sm text-secondary mb-1">Notes:</div>
                        <div>{{ search.notes }}</div>
                    </div>
                    {% endif %}
                </div>
                
                <div>
                    {% if search.is_favorite %}
                    <span class="search-badge badge-popular">Favorite</span>
                    {% elif search.last_used %}
                    <span class="search-badge badge-recent">Recent</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="search-actions">
                <a href="{% url 'search' %}?q={{ search.search_query|urlencode }}{% for key, value in search.filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                   class="btn btn-primary">
                    <i class="fas fa-search"></i> Run Search
                </a>
                
                <button class="btn btn-secondary" onclick="editSearch({{ search.id }})">
                    <i class="fas fa-edit"></i> Edit
                </button>
                
                <button class="btn btn-secondary" onclick="toggleFavoriteSearch({{ search.id }})">
                    {% if search.is_favorite %}
                    <i class="fas fa-star"></i> Remove Favorite
                    {% else %}
                    <i class="far fa-star"></i> Mark Favorite
                    {% endif %}
                </button>
                
                <button class="btn btn-danger" onclick="deleteSearch({{ search.id }})">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-bookmark"></i>
            </div>
            <h3 class="mb-2">No Saved Searches</h3>
            <p class="text-secondary mb-4">Save your frequent searches to quickly find what you're looking for</p>
            <button class="btn btn-primary" id="saveCurrentSearchBtn2">
                <i class="fas fa-plus-circle"></i> Save Your First Search
            </button>
        </div>
    {% endif %}
</div>

<!-- Pagination -->
{% if saved_searches.has_other_pages %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if saved_searches.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ saved_searches.previous_page_number }}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        {% endif %}
        
        {% for i in saved_searches.paginator.page_range %}
        {% if saved_searches.number == i %}
        <li class="page-item active">
            <span class="page-link">{{ i }}</span>
        </li>
        {% else %}
        <li class="page-item">
            <a class="page-link" href="?page={{ i }}">{{ i }}</a>
        </li>
        {% endif %}
        {% endfor %}
        
        {% if saved_searches.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ saved_searches.next_page_number }}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<script>
$(document).ready(function() {
    // Filter functionality
    $('.filter-option').click(function() {
        $('.filter-option').removeClass('active');
        $(this).addClass('active');
        
        const filter = $(this).data('filter');
        $('.search-card').show();
        
        if (filter !== 'all') {
            $('.search-card').each(function() {
                const categories = $(this).data('category').split(' ');
                if (!categories.includes(filter)) {
                    $(this).hide();
                }
            });
        }
    });
    
    // Show/hide save search form
    function showSaveForm() {
        $('#saveSearchForm').slideDown();
        
        // Get current URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q') || '';
        $('#searchQuery').val(query);
        
        // Extract filters from URL
        const filters = {};
        const filterKeys = ['gender', 'county', 'min_age', 'max_age', 'services', 'is_vip'];
        
        filterKeys.forEach(key => {
            const value = urlParams.get(key);
            if (value) {
                filters[key] = value;
            }
        });
        
        // Display filters
        const filtersContainer = $('#currentFilters');
        filtersContainer.empty();
        
        if (Object.keys(filters).length > 0) {
            Object.entries(filters).forEach(([key, value]) => {
                let displayKey = key.replace('_', ' ');
                let displayValue = value;
                
                // Format values
                if (key === 'is_vip') {
                    displayValue = value === 'true' ? 'VIP Only' : 'All';
                } else if (key === 'gender') {
                    displayKey = 'Gender';
                } else if (key === 'min_age' || key === 'max_age') {
                    displayKey = key === 'min_age' ? 'Min Age' : 'Max Age';
                }
                
                filtersContainer.append(`
                    <div class="filter-tag mb-2">
                        <i class="fas fa-filter"></i>
                        ${displayKey}: ${displayValue}
                    </div>
                `);
            });
        } else {
            filtersContainer.html('<div class="text-secondary">No filters detected from current search</div>');
        }
        
        // Store filters for later use
        $('#saveSearchFormContent').data('filters', filters);
    }
    
    function hideSaveForm() {
        $('#saveSearchForm').slideUp();
        $('#searchName').val('');
        $('#searchNotes').val('');
        $('#markFavorite').prop('checked', false);
    }
    
    $('#saveCurrentSearchBtn, #saveCurrentSearchBtn2').click(showSaveForm);
    
    // Handle save search form submission
    $('#saveSearchFormContent').submit(function(e) {
        e.preventDefault();
        
        const searchName = $('#searchName').val().trim();
        const searchQuery = $('#searchQuery').val().trim();
        const searchNotes = $('#searchNotes').val().trim();
        const isFavorite = $('#markFavorite').prop('checked');
        const filters = $(this).data('filters') || {};
        
        if (!searchName) {
            alert('Please enter a search name');
            return;
        }
        
        $.ajax({
            url: '{% url "api_save_search" %}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                name: searchName,
                query: searchQuery,
                filters: filters,
                notes: searchNotes,
                is_favorite: isFavorite
            }),
            headers: {
                'X-CSRFToken': $('meta[name="csrf-token"]').attr('content'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                showModal(`
                    <div class="text-center p-4">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h3>Search Saved!</h3>
                        <p>Your search has been saved successfully.</p>
                        <button class="btn btn-primary mt-3" onclick="location.reload()">OK</button>
                    </div>
                `);
                hideSaveForm();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'Failed to save search';
                showModal(`
                    <div class="text-center p-4">
                        <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
                        <h3>Error</h3>
                        <p>${error}</p>
                        <button class="btn btn-primary mt-3" onclick="hideModal()">OK</button>
                    </div>
                `);
            }
        });
    });
    
    // Search actions
    window.editSearch = function(searchId) {
        showModal(`
            <div class="p-4">
                <h3 class="card-title mb-3">Edit Search</h3>
                <p class="text-secondary mb-4">Feature coming soon!</p>
                <button class="btn btn-primary" onclick="hideModal()">OK</button>
            </div>
        `);
    };
    
    window.toggleFavoriteSearch = function(searchId) {
        $.ajax({
            url: '/saved-searches/' + searchId + '/toggle-favorite/',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
            },
            success: function() {
                location.reload();
            },
            error: function() {
                alert('Error updating favorite status');
            }
        });
    };
    
    window.deleteSearch = function(searchId) {
        showModal(`
            <div class="text-center p-4">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h3>Delete Saved Search</h3>
                <p>Are you sure you want to delete this saved search? This action cannot be undone.</p>
                <div class="d-flex gap-3 mt-4">
                    <button class="btn btn-danger flex-1" onclick="confirmDeleteSearch(${searchId})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    <button class="btn btn-secondary flex-1" onclick="hideModal()">Cancel</button>
                </div>
            </div>
        `);
    };
    
    window.confirmDeleteSearch = function(searchId) {
        $.ajax({
            url: '{% url "saved_search_delete" 999999999 %}'.replace('999999999', searchId),
            method: 'POST',
            headers: {
                'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
            },
            success: function() {
                location.reload();
            },
            error: function() {
                alert('Error deleting saved search');
            }
        });
    };
    
    // Auto-detect if we're coming from search page
    const referrer = document.referrer;
    if (referrer.includes('/search/') && !{{ saved_searches|yesno:"true,false" }}) {
        // Show save form automatically if coming from search with no saved searches
        setTimeout(showSaveForm, 1000);
    }
});
</script>
{% endblock %}