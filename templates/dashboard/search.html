{% extends 'base.html' %}
{% load static %}

{% block title %}Search | ConnectPlus{% endblock %}

{% block content %}
<div class="search-container">
    <!-- Search Header -->
    <div class="search-header glass-card p-4 mb-4">
        <h1 class="search-title">Find Your Perfect Match</h1>
        <p class="search-subtitle">Search through thousands of verified profiles</p>
        
        <!-- Search Form -->
        <form method="get" class="search-form mt-4">
            <div class="grid grid-4 gap-3">
                <div class="form-group">
                    <input type="text" name="query" class="form-control" 
                           placeholder="Search by name or services..." 
                           value="{{ form.query.value|default:'' }}">
                </div>
                
                <div class="form-group">
                    <select name="gender" class="form-control">
                        <option value="">Any Gender</option>
                        {% for value, label in profile_gender_choices %}
                        <option value="{{ value }}" 
                                {% if form.gender.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <input type="text" name="county" class="form-control" 
                           placeholder="County" 
                           value="{{ form.county.value|default:'' }}">
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="ri-search-line"></i> Search
                    </button>
                </div>
            </div>
            
            <!-- Advanced Filters -->
            <div class="advanced-filters mt-3">
                <a href="#" class="filter-toggle" onclick="toggleFilters()">
                    <i class="ri-filter-3-line"></i> Advanced Filters
                </a>
                
                <div class="filter-content" id="filterContent" style="display: none;">
                    <div class="grid grid-4 gap-3 mt-3">
                        <div class="form-group">
                            <label>Min Age</label>
                            <input type="number" name="min_age" class="form-control" 
                                   min="18" max="100" 
                                   value="{{ form.min_age.value|default:'' }}">
                        </div>
                        
                        <div class="form-group">
                            <label>Max Age</label>
                            <input type="number" name="max_age" class="form-control" 
                                   min="18" max="100" 
                                   value="{{ form.max_age.value|default:'' }}">
                        </div>
                        
                        <div class="form-group">
                            <label>Services</label>
                            <input type="text" name="services" class="form-control" 
                                   placeholder="Dinner date, travel..." 
                                   value="{{ form.services.value|default:'' }}">
                        </div>
                        
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="is_vip" 
                                       {% if form.is_vip.value %}checked{% endif %}>
                                <span>VIP Only</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Results Count -->
    <div class="results-info mb-4">
        <p class="results-count">
            Found <strong>{{ page_obj.paginator.count }}</strong> profiles
            {% if form.query.value %}
            for "{{ form.query.value }}"
            {% endif %}
        </p>
        
        <div class="results-actions">
            <button class="btn btn-outline btn-sm" onclick="saveSearch()">
                <i class="ri-bookmark-line"></i> Save Search
            </button>
            <div class="view-toggle">
                <button class="view-btn active" onclick="setView('grid')">
                    <i class="ri-grid-line"></i>
                </button>
                <button class="view-btn" onclick="setView('list')">
                    <i class="ri-list-check"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Profiles Grid -->
    <div class="profiles-grid" id="profilesView">
        {% if page_obj %}
        <div class="grid grid-4 gap-4">
            {% for profile in page_obj %}
            <div class="profile-card glass-card">
                <div class="profile-header">
                    {% with photo=profile.photos.first %}
                    {% if photo %}
                    <img src="{{ photo.image.url }}" alt="{{ profile.user.username }}" class="profile-cover">
                    {% else %}
                    <div class="profile-cover-placeholder">
                        <i class="ri-image-line"></i>
                    </div>
                    {% endif %}
                    {% endwith %}
                    
                    {% if profile.is_vip %}
                    <span class="profile-badge vip">
                        <i class="ri-vip-crown-fill"></i> VIP
                    </span>
                    {% endif %}
                    
                    {% if profile.is_online %}
                    <span class="online-badge">
                        <i class="ri-checkbox-blank-circle-fill"></i> Online
                    </span>
                    {% endif %}
                    
                    <div class="profile-avatar-container">
                        {% with photo=profile.photos.first %}
                        {% if photo %}
                        <img src="{{ photo.image.url }}" alt="{{ profile.user.username }}">
                        {% else %}
                        <div class="avatar-placeholder">
                            {{ profile.user.username|first|upper }}
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
                
                <div class="profile-body">
                    <h3 class="profile-name">
                        <a href="{% url 'profile_view' profile.user.username %}">
                            {{ profile.user.username }}
                        </a>
                    </h3>
                    
                    <div class="profile-location">
                        <i class="ri-map-pin-line"></i>
                        {{ profile.city_town }}, {{ profile.county }}
                    </div>
                    
                    <div class="profile-meta">
                        <span class="meta-item">
                            <i class="ri-user-line"></i> {{ profile.age }}
                        </span>
                        <span class="meta-item">
                            <i class="ri-genderless-line"></i> {{ profile.get_gender_display }}
                        </span>
                    </div>
                    
                    {% if profile.services_offered %}
                    <div class="profile-services">
                        {% for service in profile.get_services_list|slice:":3" %}
                        <span class="service-tag">{{ service }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value">{{ profile.total_views }}</div>
                            <div class="stat-label">Views</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ profile.rating|floatformat:1 }}</div>
                            <div class="stat-label">Rating</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">
                                {% if profile.hourly_rate_incall %}
                                KES {{ profile.hourly_rate_incall|floatformat:0 }}
                                {% else %}
                                N/A
                                {% endif %}
                            </div>
                            <div class="stat-label">Rate</div>
                        </div>
                    </div>
                    
                    <div class="profile-footer">
                        <a href="{% url 'profile_view' profile.user.username %}" 
                           class="btn btn-outline btn-sm w-100">
                            View Profile
                        </a>
                        <button onclick="quickContact('{{ profile.user.username }}')" 
                                class="btn btn-primary btn-sm w-100 mt-2">
                            <i class="ri-message-2-line"></i> Message
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="pagination mt-5">
            <nav>
                <ul class="pagination-list">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                           class="page-link">
                            <i class="ri-arrow-left-line"></i>
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                               class="page-link">{{ num }}</a>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                           class="page-link">
                            <i class="ri-arrow-right-line"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-results text-center p-5">
            <i class="ri-search-line text-muted" style="font-size: 4rem;"></i>
            <h3 class="mt-3">No profiles found</h3>
            <p class="text-muted">Try adjusting your search filters</p>
            <button class="btn btn-primary mt-3" onclick="clearFilters()">
                Clear Filters
            </button>
        </div>
        {% endif %}
    </div>
    
    <!-- Quick Contact Modal -->
    <div class="modal-overlay" id="quickContactModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Quick Message</h3>
                <button class="modal-close" onclick="closeQuickContact()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>To:</label>
                    <input type="text" class="form-control" id="contactUsername" readonly>
                </div>
                <div class="form-group">
                    <label>Message:</label>
                    <textarea class="form-control" id="quickMessage" rows="4" 
                              placeholder="Type your message here..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeQuickContact()">Cancel</button>
                <button class="btn btn-primary" onclick="sendQuickMessage()">Send</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentView = 'grid';
let currentUsername = '';

function toggleFilters() {
    const content = $('#filterContent');
    content.slideToggle();
}

function setView(view) {
    currentView = view;
    const viewBtns = $('.view-btn');
    viewBtns.removeClass('active');
    $(`.view-btn:contains("${view === 'grid' ? 'Grid' : 'List'}")`).addClass('active');
    
    if (view === 'grid') {
        $('#profilesView').removeClass('list-view').addClass('grid-view');
    } else {
        $('#profilesView').removeClass('grid-view').addClass('list-view');
    }
}

function saveSearch() {
    const filters = {
        query: $('[name="query"]').val(),
        gender: $('[name="gender"]').val(),
        county: $('[name="county"]').val(),
        min_age: $('[name="min_age"]').val(),
        max_age: $('[name="max_age"]').val(),
        services: $('[name="services"]').val(),
        is_vip: $('[name="is_vip"]').is(':checked')
    };
    
    $.ajax({
        url: '{% url "api_save_search" %}',
        type: 'POST',
        data: JSON.stringify({
            query: $('[name="query"]').val(),
            filters: filters
        }),
        contentType: 'application/json',
        success: function(response) {
            showToast('Search saved successfully!', 'success');
        },
        error: function(xhr) {
            showToast(xhr.responseJSON.error, 'error');
        }
    });
}

function quickContact(username) {
    currentUsername = username;
    $('#contactUsername').val(username);
    $('#quickContactModal').addClass('active');
    $('#quickMessage').focus();
}

function closeQuickContact() {
    $('#quickContactModal').removeClass('active');
    currentUsername = '';
    $('#quickMessage').val('');
}

function sendQuickMessage() {
    const message = $('#quickMessage').val().trim();
    
    if (!message) {
        showToast('Please enter a message', 'error');
        return;
    }
    
    $.ajax({
        url: `/conversation/user/${currentUsername}/`,
        type: 'POST',
        data: {
            'content': message,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function() {
            closeQuickContact();
            showToast('Message sent!', 'success');
        },
        error: function(xhr) {
            showToast('Failed to send message', 'error');
        }
    });
}

function clearFilters() {
    window.location.href = '{% url "search" %}';
}

function showToast(message, type) {
    const toast = $(`
        <div class="toast toast-${type} glass-card">
            <span>${message}</span>
            <button class="toast-close">&times;</button>
        </div>
    `);
    
    $('.main-content').append(toast);
    
    setTimeout(() => {
        toast.fadeOut(() => toast.remove());
    }, 3000);
}

// Close modal on click outside
$('.modal-overlay').on('click', function(e) {
    if (e.target === this) {
        $(this).removeClass('active');
    }
});
</script>
{% endblock %}