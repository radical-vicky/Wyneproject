{% extends 'base.html' %}
{% load static %}

{% block title %}Archived Posts - CoopConnect Premium{% endblock %}

{% block extra_css %}
<style>
/* Archived Posts Specific Styles */
.archived-header {
    background: linear-gradient(135deg, rgba(102, 102, 102, 0.1), rgba(68, 68, 68, 0.1));
    border-radius: var(--radius-lg);
    padding: 30px;
    margin-bottom: 30px;
    border: 1px solid rgba(102, 102, 102, 0.2);
}

.archive-actions {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.post-filters {
    background: var(--darker-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 20px 0;
}

.filter-group {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
}

.filter-btn {
    padding: 8px 16px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 6px;
}

.filter-btn:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: var(--coop-green);
    color: var(--text-primary);
}

.filter-btn.active {
    background: rgba(0, 168, 89, 0.1);
    border-color: var(--coop-green);
    color: var(--coop-green);
}

.archive-stats {
    display: flex;
    gap: 30px;
    margin: 25px 0;
    flex-wrap: wrap;
}

.stat-item {
    text-align: center;
    padding: 15px;
    background: var(--darker-bg);
    border-radius: var(--radius);
    min-width: 120px;
    flex: 1;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--coop-green);
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.empty-archive {
    text-align: center;
    padding: 60px 20px;
    background: var(--darker-bg);
    border-radius: var(--radius-lg);
    margin: 40px 0;
}

.empty-icon {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(102, 102, 102, 0.1), rgba(68, 68, 68, 0.1));
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    color: var(--text-muted);
    font-size: 3rem;
}

.posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin: 30px 0;
}

.post-card {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    overflow: hidden;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.post-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
    border-color: var(--coop-green);
}

.post-media {
    position: relative;
    height: 200px;
    overflow: hidden;
}

.post-media img, .post-media video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.post-card:hover .post-media img,
.post-card:hover .post-media video {
    transform: scale(1.05);
}

.post-type-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    padding: 4px 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    z-index: 2;
}

.multi-media-indicator {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 4px 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border-radius: 12px;
    font-size: 0.7rem;
    z-index: 2;
    display: flex;
    align-items: center;
    gap: 5px;
}

.post-content {
    padding: 20px;
}

.post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}

.post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
}

.post-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.post-author {
    flex: 1;
}

.post-author-name {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 2px;
}

.post-time {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.post-text {
    color: var(--text-primary);
    margin-bottom: 15px;
    line-height: 1.5;
    max-height: 60px;
    overflow: hidden;
    position: relative;
}

.post-text.expanded {
    max-height: none;
}

.read-more {
    background: linear-gradient(transparent, var(--card-bg));
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 20px 0 5px;
    text-align: center;
}

.read-more-btn {
    color: var(--coop-green);
    font-size: 0.8rem;
    cursor: pointer;
    background: none;
    border: none;
}

.post-stats {
    display: flex;
    gap: 15px;
    margin: 15px 0;
    padding: 10px 0;
    border-top: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
}

.stat-count {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.stat-count i {
    font-size: 0.9rem;
}

.post-actions {
    display: flex;
    gap: 10px;
    justify-content: space-between;
}

.archive-date {
    font-size: 0.8rem;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 5px;
}

.bulk-actions {
    background: var(--darker-bg);
    border-radius: var(--radius);
    padding: 20px;
    margin: 20px 0;
    position: sticky;
    top: 20px;
    z-index: 10;
    border: 1px solid var(--border-color);
}

.bulk-selection-info {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 15px;
}

.selection-count {
    font-weight: 600;
    color: var(--coop-green);
}

.bulk-action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.search-archive {
    margin: 20px 0;
}

.search-input-group {
    position: relative;
}

.search-input-group .search-input {
    padding-left: 45px;
}

.search-input-group .search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
}

.sort-options {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.sort-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.sort-select {
    background: var(--darker-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 8px 15px;
    color: var(--text-primary);
    min-width: 150px;
}

.view-toggle {
    display: flex;
    gap: 5px;
    background: var(--darker-bg);
    border-radius: var(--radius);
    padding: 4px;
}

.view-btn {
    padding: 6px 12px;
    border-radius: 6px;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
}

.view-btn.active {
    background: var(--coop-green);
    color: white;
}

.list-view .posts-grid {
    grid-template-columns: 1fr;
}

.list-view .post-card {
    display: flex;
    min-height: 150px;
}

.list-view .post-media {
    width: 200px;
    height: 150px;
    flex-shrink: 0;
}

.list-view .post-content {
    flex: 1;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin: 40px 0;
}

.page-btn {
    padding: 8px 15px;
    background: var(--darker-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.3s ease;
}

.page-btn:hover:not(:disabled) {
    background: rgba(0, 168, 89, 0.1);
    border-color: var(--coop-green);
}

.page-btn.active {
    background: var(--coop-green);
    border-color: var(--coop-green);
    color: white;
}

.page-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.archive-categories {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 20px 0;
}

.category-tag {
    padding: 6px 15px;
    background: var(--darker-bg);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    font-size: 0.8rem;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
}

.category-tag:hover {
    background: rgba(0, 168, 89, 0.1);
    border-color: var(--coop-green);
    color: var(--coop-green);
}

.category-tag.active {
    background: rgba(0, 168, 89, 0.2);
    border-color: var(--coop-green);
    color: var(--coop-green);
}

.restore-animation {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
    background: var(--coop-green);
    color: white;
    padding: 20px 40px;
    border-radius: var(--radius-lg);
    animation: slideInUp 0.5s ease;
    display: none;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translate(-50%, 100%);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%);
    }
}

@media (max-width: 992px) {
    .posts-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
    
    .list-view .post-card {
        flex-direction: column;
    }
    
    .list-view .post-media {
        width: 100%;
        height: 200px;
    }
    
    .archive-stats {
        gap: 15px;
    }
    
    .stat-item {
        min-width: 100px;
    }
}

@media (max-width: 768px) {
    .archived-header {
        padding: 20px;
    }
    
    .posts-grid {
        grid-template-columns: 1fr;
    }
    
    .bulk-selection-info {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .bulk-action-buttons {
        width: 100%;
    }
    
    .bulk-action-buttons .btn {
        flex: 1;
        justify-content: center;
    }
    
    .archive-actions {
        flex-direction: column;
    }
    
    .archive-actions .btn {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 576px) {
    .post-actions {
        flex-direction: column;
        gap: 10px;
    }
    
    .post-actions .btn {
        width: 100%;
        justify-content: center;
    }
    
    .filter-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-btn {
        justify-content: center;
    }
    
    .sort-options {
        flex-direction: column;
        align-items: stretch;
    }
    
    .sort-select {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Archived Posts Header -->
    <div class="archived-header">
        <div class="row align-center">
            <div class="col-md-8">
                <h1 class="mb-1">
                    <i class="fas fa-archive text-secondary"></i> Archived Posts
                </h1>
                <p class="text-secondary">Posts you've archived for later reference</p>
                
                <div class="archive-actions">
                    <button class="btn btn-primary" onclick="restoreSelected()">
                        <i class="fas fa-undo"></i> Restore Selected
                    </button>
                    <button class="btn btn-secondary" onclick="downloadArchive()">
                        <i class="fas fa-download"></i> Export Archive
                    </button>
                    <button class="btn btn-danger" onclick="deleteSelected()">
                        <i class="fas fa-trash"></i> Delete Selected
                    </button>
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Posts
                    </a>
                </div>
            </div>
            
            <div class="col-md-4 text-center">
                <div class="archive-stats">
                    <div class="stat-item">
                        <div class="stat-value">{{ total_posts }}</div>
                        <div class="stat-label">Total Archived</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ storage_used }}</div>
                        <div class="stat-label">Storage Used</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Bar (Hidden by default) -->
    <div id="bulkActionsBar" class="bulk-actions d-none">
        <div class="bulk-selection-info">
            <div>
                <span class="selection-count" id="selectedCount">0</span> posts selected
            </div>
            <div class="bulk-action-buttons">
                <button class="btn btn-sm btn-primary" onclick="restoreSelected()">
                    <i class="fas fa-undo"></i> Restore
                </button>
                <button class="btn btn-sm btn-secondary" onclick="downloadSelected()">
                    <i class="fas fa-download"></i> Download
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteSelected()">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button class="btn btn-sm btn-secondary" onclick="clearSelection()">
                    <i class="fas fa-times"></i> Clear Selection
                </button>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row">
        <div class="col-md-8">
            <div class="search-archive">
                <div class="search-input-group">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Search archived posts..." id="archiveSearch">
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="sort-options">
                <span class="sort-label">Sort by:</span>
                <select class="sort-select" id="sortSelect" onchange="sortPosts()">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="popular">Most Popular</option>
                    <option value="name">Post Title</option>
                </select>
                
                <div class="view-toggle">
                    <button class="view-btn active" data-view="grid" onclick="toggleView('grid')">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button class="view-btn" data-view="list" onclick="toggleView('list')">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Post Filters -->
    <div class="post-filters">
        <div class="filter-group">
            <button class="filter-btn active" data-filter="all" onclick="filterPosts('all')">
                <i class="fas fa-layer-group"></i> All Posts
            </button>
            <button class="filter-btn" data-filter="images" onclick="filterPosts('images')">
                <i class="fas fa-image"></i> Images
            </button>
            <button class="filter-btn" data-filter="videos" onclick="filterPosts('videos')">
                <i class="fas fa-video"></i> Videos
            </button>
            <button class="filter-btn" data-filter="text" onclick="filterPosts('text')">
                <i class="fas fa-file-alt"></i> Text Only
            </button>
            <button class="filter-btn" data-filter="popular" onclick="filterPosts('popular')">
                <i class="fas fa-fire"></i> Most Popular
            </button>
        </div>
        
        <!-- Date Range Filter -->
        <div class="row mt-3">
            <div class="col-md-6">
                <label class="form-label">Archived From</label>
                <input type="date" class="form-control" id="dateFrom" onchange="filterByDate()">
            </div>
            <div class="col-md-6">
                <label class="form-label">Archived To</label>
                <input type="date" class="form-control" id="dateTo" onchange="filterByDate()">
            </div>
        </div>
    </div>

    <!-- Categories -->
    {% if categories %}
    <div class="archive-categories">
        {% for category in categories %}
        <span class="category-tag" data-category="{{ category.id }}" onclick="filterByCategory('{{ category.id }}')">
            {{ category.name }} ({{ category.post_count }})
        </span>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Archived Posts Grid -->
    {% if posts %}
    <div id="postsContainer" class="posts-grid">
        {% for post in posts %}
        <div class="post-card" data-post-id="{{ post.id }}" data-type="{{ post.content_type }}" data-category="{{ post.category.id|default:'' }}">
            <!-- Post Selection Checkbox -->
            <div class="post-checkbox" style="position: absolute; top: 10px; left: 10px; z-index: 3;">
                <input type="checkbox" class="post-select" data-post-id="{{ post.id }}" style="transform: scale(1.3);">
            </div>
            
            <!-- Post Media -->
            {% if post.media.first %}
            <div class="post-media">
                {% if post.content_type == 'image' %}
                <img src="{{ post.media.first.file.url }}" alt="{{ post.title|default:'Post image' }}">
                <span class="post-type-badge">
                    <i class="fas fa-image"></i> Image
                </span>
                {% elif post.content_type == 'video' %}
                <video src="{{ post.media.first.file.url }}" poster="{{ post.thumbnail.url|default:'' }}">
                    Your browser does not support the video tag.
                </video>
                <span class="post-type-badge">
                    <i class="fas fa-video"></i> Video
                </span>
                {% endif %}
                
                {% if post.media.count > 1 %}
                <span class="multi-media-indicator">
                    <i class="fas fa-layer-group"></i> {{ post.media.count }}
                </span>
                {% endif %}
            </div>
            {% else %}
            <div class="post-media" style="background: var(--darker-bg); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-file-alt fa-3x text-muted"></i>
                <span class="post-type-badge">
                    <i class="fas fa-file-alt"></i> Text
                </span>
            </div>
            {% endif %}
            
            <!-- Post Content -->
            <div class="post-content">
                <div class="post-header">
                    <div class="post-avatar">
                        {% if post.author.profile.photos.first %}
                        <img src="{{ post.author.profile.photos.first.image.url }}" alt="{{ post.author.username }}">
                        {% else %}
                        <div class="d-flex align-center justify-center h-100" style="background: var(--coop-green);">
                            <i class="fas fa-user"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="post-author">
                        <div class="post-author-name">{{ post.author.username }}</div>
                        <div class="post-time">
                            <i class="fas fa-clock"></i> {{ post.created_at|date:"M j, Y" }}
                        </div>
                    </div>
                </div>
                
                {% if post.title %}
                <h4 class="mb-2">{{ post.title }}</h4>
                {% endif %}
                
                <div class="post-text" id="postText{{ post.id }}">
                    {{ post.content|truncatechars:150 }}
                </div>
                
                {% if post.content|length > 150 %}
                <button class="read-more-btn" onclick="toggleReadMore('{{ post.id }}')">Read more</button>
                {% endif %}
                
                <!-- Post Stats -->
                <div class="post-stats">
                    <div class="stat-count">
                        <i class="fas fa-heart text-danger"></i>
                        <span>{{ post.likes_count|default:"0" }}</span>
                    </div>
                    <div class="stat-count">
                        <i class="fas fa-comment text-info"></i>
                        <span>{{ post.comments_count|default:"0" }}</span>
                    </div>
                    <div class="stat-count">
                        <i class="fas fa-share text-success"></i>
                        <span>{{ post.shares_count|default:"0" }}</span>
                    </div>
                </div>
                
                <!-- Post Actions -->
                <div class="post-actions">
                    <div class="archive-date">
                        <i class="fas fa-archive"></i>
                        Archived {{ post.archived_at|date:"M j, Y" }}
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-primary" onclick="restorePost('{{ post.id }}')">
                            <i class="fas fa-undo"></i> Restore
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="previewPost('{{ post.id }}')">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    <div class="pagination">
        {% if page_obj.has_previous %}
        <button class="page-btn" onclick="goToPage(1)">
            <i class="fas fa-angle-double-left"></i>
        </button>
        <button class="page-btn" onclick="goToPage({{ page_obj.previous_page_number }})">
            <i class="fas fa-angle-left"></i>
        </button>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <button class="page-btn active">{{ num }}</button>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <button class="page-btn" onclick="goToPage({{ num }})">{{ num }}</button>
            {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
        <button class="page-btn" onclick="goToPage({{ page_obj.next_page_number }})">
            <i class="fas fa-angle-right"></i>
        </button>
        <button class="page-btn" onclick="goToPage({{ page_obj.paginator.num_pages }})">
            <i class="fas fa-angle-double-right"></i>
        </button>
        {% endif %}
    </div>
    
    {% else %}
    <!-- Empty State -->
    <div class="empty-archive">
        <div class="empty-icon">
            <i class="fas fa-archive"></i>
        </div>
        <h3 class="mb-3">No Archived Posts</h3>
        <p class="text-secondary mb-4">You haven't archived any posts yet.</p>
        <div class="d-flex gap-3 justify-content-center">
            <a href="{% url 'dashboard' %}" class="btn btn-primary">
                <i class="fas fa-stream"></i> Browse Posts
            </a>
            <a href="{% url 'post_create' %}" class="btn btn-secondary">
                <i class="fas fa-plus"></i> Create Post
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Restore Animation -->
<div class="restore-animation" id="restoreAnimation">
    <div class="text-center">
        <i class="fas fa-check-circle fa-3x mb-3"></i>
        <h4>Post Restored!</h4>
    </div>
</div>

<!-- Preview Modal Content -->
<div id="previewModalContent" style="display: none;">
    <!-- Content will be loaded dynamically -->
</div>

<!-- Export Options Modal -->
<div id="exportModalContent" style="display: none;">
    <h3 class="card-title mb-3">Export Archived Posts</h3>
    <form id="exportForm" onsubmit="processExport(event)">
        <div class="form-group">
            <label class="form-label">Export Format</label>
            <select class="form-control" name="format">
                <option value="pdf">PDF Document</option>
                <option value="json">JSON Data</option>
                <option value="csv">CSV Spreadsheet</option>
                <option value="html">HTML Archive</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Include</label>
            <div class="d-flex flex-column gap-2">
                <label class="form-check">
                    <input type="checkbox" class="form-check-input" name="include_media" checked>
                    <span class="form-check-label">Media files</span>
                </label>
                <label class="form-check">
                    <input type="checkbox" class="form-check-input" name="include_comments" checked>
                    <span class="form-check-label">Comments</span>
                </label>
                <label class="form-check">
                    <input type="checkbox" class="form-check-input" name="include_metadata" checked>
                    <span class="form-check-label">Post metadata</span>
                </label>
                <label class="form-check">
                    <input type="checkbox" class="form-check-input" name="include_stats" checked>
                    <span class="form-check-label">Statistics</span>
                </label>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Date Range</label>
            <div class="row">
                <div class="col-6">
                    <input type="date" class="form-control" name="start_date">
                </div>
                <div class="col-6">
                    <input type="date" class="form-control" name="end_date">
                </div>
            </div>
        </div>
        
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <div>
                <strong>Export Information</strong>
                <div class="text-sm">Large archives may take several minutes to process.</div>
            </div>
        </div>
        
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-1">
                <i class="fas fa-download"></i> Export Now
            </button>
            <button type="button" class="btn btn-secondary" onclick="hideModal()">Cancel</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize post selection
    initializeSelection();
    
    // Initialize search
    $('#archiveSearch').on('input', debounce(searchPosts, 500));
    
    // Initialize filters
    initializeFilters();
});

let selectedPosts = new Set();
let currentView = 'grid';

// Initialize post selection
function initializeSelection() {
    $('.post-select').change(function() {
        const postId = $(this).data('post-id');
        
        if ($(this).is(':checked')) {
            selectedPosts.add(postId);
        } else {
            selectedPosts.delete(postId);
        }
        
        updateSelectionUI();
    });
}

// Update selection UI
function updateSelectionUI() {
    const count = selectedPosts.size;
    $('#selectedCount').text(count);
    
    if (count > 0) {
        $('#bulkActionsBar').removeClass('d-none');
    } else {
        $('#bulkActionsBar').addClass('d-none');
    }
}

// Clear selection
function clearSelection() {
    $('.post-select').prop('checked', false);
    selectedPosts.clear();
    updateSelectionUI();
}

// Select all posts
function selectAllPosts() {
    $('.post-select').prop('checked', true);
    $('.post-select').each(function() {
        selectedPosts.add($(this).data('post-id'));
    });
    updateSelectionUI();
}

// Toggle view between grid and list
function toggleView(view) {
    currentView = view;
    const postsContainer = $('#postsContainer');
    const viewBtns = $('.view-btn');
    
    // Update active button
    viewBtns.removeClass('active');
    $(`.view-btn[data-view="${view}"]`).addClass('active');
    
    // Toggle view class
    postsContainer.removeClass('grid-view list-view');
    postsContainer.addClass(view + '-view');
}

// Filter posts
function filterPosts(filterType) {
    // Update active filter button
    $('.filter-btn').removeClass('active');
    $(`.filter-btn[data-filter="${filterType}"]`).addClass('active');
    
    // Filter posts
    $('.post-card').show();
    
    if (filterType !== 'all') {
        $('.post-card').each(function() {
            const postType = $(this).data('type');
            const shouldShow = 
                (filterType === 'images' && postType === 'image') ||
                (filterType === 'videos' && postType === 'video') ||
                (filterType === 'text' && !postType) ||
                (filterType === 'popular' && parseInt($(this).find('.stat-count:first span').text()) > 10);
            
            if (!shouldShow) {
                $(this).hide();
            }
        });
    }
}

// Filter by category
function filterByCategory(categoryId) {
    $('.category-tag').removeClass('active');
    $(`.category-tag[data-category="${categoryId}"]`).addClass('active');
    
    if (!categoryId) {
        $('.post-card').show();
        return;
    }
    
    $('.post-card').each(function() {
        const postCategory = $(this).data('category');
        if (postCategory === categoryId) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
}

// Filter by date
function filterByDate() {
    const dateFrom = $('#dateFrom').val();
    const dateTo = $('#dateTo').val();
    
    if (!dateFrom && !dateTo) return;
    
    // In a real application, this would be an AJAX call
    console.log('Filtering by date:', dateFrom, 'to', dateTo);
}

// Sort posts
function sortPosts() {
    const sortBy = $('#sortSelect').val();
    
    // In a real application, this would be an AJAX call
    console.log('Sorting by:', sortBy);
}

// Search posts
function searchPosts() {
    const query = $('#archiveSearch').val().toLowerCase();
    
    if (query.length < 2) {
        $('.post-card').show();
        return;
    }
    
    $('.post-card').each(function() {
        const postText = $(this).find('.post-text').text().toLowerCase();
        const postTitle = $(this).find('h4').text().toLowerCase();
        const authorName = $(this).find('.post-author-name').text().toLowerCase();
        
        if (postText.includes(query) || postTitle.includes(query) || authorName.includes(query)) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
}

// Debounce function for search
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Toggle read more
function toggleReadMore(postId) {
    const textElement = $(`#postText${postId}`);
    const button = textElement.next('.read-more-btn');
    
    if (textElement.hasClass('expanded')) {
        textElement.removeClass('expanded');
        button.text('Read more');
    } else {
        textElement.addClass('expanded');
        button.text('Read less');
    }
}

// Restore single post
function restorePost(postId) {
    if (confirm('Restore this post? It will be visible to your contacts again.')) {
        $.ajax({
            url: `/api/posts/${postId}/restore/`,
            method: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    showRestoreAnimation();
                    $(`.post-card[data-post-id="${postId}"]`).fadeOut(300, function() {
                        $(this).remove();
                        updatePostCount();
                    });
                } else {
                    alert('Failed to restore post: ' + response.message);
                }
            },
            error: function() {
                alert('Error restoring post. Please try again.');
            }
        });
    }
}

// Restore selected posts
function restoreSelected() {
    if (selectedPosts.size === 0) {
        alert('Please select posts to restore.');
        return;
    }
    
    if (confirm(`Restore ${selectedPosts.size} selected posts? They will be visible to your contacts again.`)) {
        $.ajax({
            url: '/api/posts/restore-bulk/',
            method: 'POST',
            data: {
                post_ids: Array.from(selectedPosts),
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    showRestoreAnimation();
                    selectedPosts.forEach(postId => {
                        $(`.post-card[data-post-id="${postId}"]`).fadeOut(300, function() {
                            $(this).remove();
                        });
                    });
                    selectedPosts.clear();
                    updateSelectionUI();
                    updatePostCount();
                } else {
                    alert('Failed to restore posts: ' + response.message);
                }
            },
            error: function() {
                alert('Error restoring posts. Please try again.');
            }
        });
    }
}

// Delete selected posts
function deleteSelected() {
    if (selectedPosts.size === 0) {
        alert('Please select posts to delete.');
        return;
    }
    
    if (confirm(`Permanently delete ${selectedPosts.size} selected posts? This action cannot be undone.`)) {
        $.ajax({
            url: '/api/posts/delete-bulk/',
            method: 'POST',
            data: {
                post_ids: Array.from(selectedPosts),
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    showMessage('Posts deleted successfully!', 'success');
                    selectedPosts.forEach(postId => {
                        $(`.post-card[data-post-id="${postId}"]`).fadeOut(300, function() {
                            $(this).remove();
                        });
                    });
                    selectedPosts.clear();
                    updateSelectionUI();
                    updatePostCount();
                } else {
                    alert('Failed to delete posts: ' + response.message);
                }
            },
            error: function() {
                alert('Error deleting posts. Please try again.');
            }
        });
    }
}

// Download archive
function downloadArchive() {
    showModal($('#exportModalContent').html());
}

function processExport(event) {
    event.preventDefault();
    
    // Show processing
    $('#modalContent').html(`
        <div class="text-center p-5">
            <div class="processing-icon mb-4">
                <i class="fas fa-spinner fa-spin fa-3x"></i>
            </div>
            <h4 class="mb-2">Preparing Export</h4>
            <p class="text-secondary">This may take a few minutes...</p>
            <div class="progress-bar mt-4">
                <div class="progress-fill" id="exportProgress" style="width: 0%"></div>
            </div>
        </div>
    `);
    
    // Simulate export process
    let progress = 0;
    const interval = setInterval(() => {
        progress += 2;
        $('#exportProgress').css('width', progress + '%');
        
        if (progress >= 100) {
            clearInterval(interval);
            
            // Simulate download
            const blob = new Blob(['Archived posts export'], { type: 'application/zip' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `archived-posts-${new Date().toISOString().split('T')[0]}.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('Archive exported successfully!', 'success');
            hideModal();
        }
    }, 100);
}

// Download selected posts
function downloadSelected() {
    if (selectedPosts.size === 0) {
        alert('Please select posts to download.');
        return;
    }
    
    // Show processing
    showModal(`
        <div class="text-center p-5">
            <div class="processing-icon mb-4">
                <i class="fas fa-spinner fa-spin fa-3x"></i>
            </div>
            <h4 class="mb-2">Preparing Download</h4>
            <p class="text-secondary">Compressing ${selectedPosts.size} selected posts...</p>
        </div>
    `);
    
    // Simulate download preparation
    setTimeout(() => {
        const blob = new Blob(['Selected posts download'], { type: 'application/zip' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `selected-posts-${new Date().toISOString().split('T')[0]}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showMessage('Posts downloaded successfully!', 'success');
        hideModal();
    }, 2000);
}

// Preview post
function previewPost(postId) {
    $.ajax({
        url: `/api/posts/${postId}/preview/`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                showModal(response.html);
            } else {
                alert('Failed to load post preview.');
            }
        },
        error: function() {
            alert('Error loading post preview.');
        }
    });
}

// Update post count
function updatePostCount() {
    const remainingPosts = $('.post-card').length;
    $('.stat-value').first().text(remainingPosts);
    
    if (remainingPosts === 0) {
        // Show empty state
        $('#postsContainer').html(`
            <div class="empty-archive">
                <div class="empty-icon">
                    <i class="fas fa-archive"></i>
                </div>
                <h3 class="mb-3">No Archived Posts</h3>
                <p class="text-secondary mb-4">You haven't archived any posts yet.</p>
            </div>
        `);
    }
}

// Show restore animation
function showRestoreAnimation() {
    const animation = $('#restoreAnimation');
    animation.fadeIn(300);
    
    setTimeout(() => {
        animation.fadeOut(300);
    }, 2000);
}

// Go to page
function goToPage(pageNumber) {
    window.location.href = `{% url 'archived_posts' %}?page=${pageNumber}`;
}

// Show message
function showMessage(message, type) {
    const alert = $(`
        <div class="alert alert-${type}">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <span>${message}</span>
        </div>
    `);
    
    $('.messages-container').append(alert);
    
    setTimeout(() => {
        alert.fadeOut(300, () => alert.remove());
    }, 5000);
}

// Initialize filters
function initializeFilters() {
    // Set default date range (last 30 days)
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    $('#dateFrom').val(thirtyDaysAgo.toISOString().split('T')[0]);
    $('#dateTo').val(today.toISOString().split('T')[0]);
}
</script>
{% endblock %}