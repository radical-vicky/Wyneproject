<div class="card glass-hover">
    <!-- Post Header -->
    <div class="p-4 border-b border-glass">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="{% url 'profile_view' post.user.username %}">
                    {% with post.user.profile.photos.all|first as photo %}
                    {% if photo %}
                    <img src="{{ photo.image.url }}" 
                         alt="{{ post.user.username }}"
                         class="w-10 h-10 rounded-full object-cover">
                    {% else %}
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-500 to-cyan-400 flex items-center justify-center">
                        <span class="text-white font-bold">{{ post.user.username|first|upper }}</span>
                    </div>
                    {% endif %}
                    {% endwith %}
                </a>
                <div>
                    <a href="{% url 'profile_view' post.user.username %}" class="font-bold hover:text-accent-primary">
                        {{ post.user.username }}
                    </a>
                    <p class="text-xs text-muted">
                        {{ post.created_at|timesince }} ago
                        {% if post.location %}
                        Â· <i class="fas fa-map-marker-alt"></i> {{ post.location }}
                        {% endif %}
                    </p>
                </div>
            </div>
            
            <div class="relative">
                <button onclick="togglePostMenu('{{ post.id }}')" class="p-2 rounded-lg hover:bg-glass">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
                
                <!-- Post Menu Dropdown -->
                <div id="post-menu-{{ post.id }}" class="hidden absolute right-0 mt-2 w-48 glass rounded-lg p-2 space-y-1 z-10">
                    {% if request.user == post.user %}
                    <a href="{% url 'post_detail' post.id %}" class="block p-2 rounded hover:bg-glass-hover">
                        <i class="fas fa-eye mr-2"></i> View Post
                    </a>
                    <a href="#" class="block p-2 rounded hover:bg-glass-hover">
                        <i class="fas fa-edit mr-2"></i> Edit Post
                    </a>
                    <button onclick="archivePost('{{ post.id }}')" class="w-full text-left p-2 rounded hover:bg-glass-hover">
                        <i class="fas fa-archive mr-2"></i> 
                        {% if post.is_archived %}Unarchive{% else %}Archive{% endif %}
                    </button>
                    <button onclick="confirmDeletePost('{{ post.id }}')" class="w-full text-left p-2 rounded hover:bg-glass-hover text-red-400">
                        <i class="fas fa-trash mr-2"></i> Delete Post
                    </button>
                    {% else %}
                    <button onclick="savePost('{{ post.id }}')" class="w-full text-left p-2 rounded hover:bg-glass-hover">
                        <i class="fas fa-bookmark mr-2"></i> Save Post
                    </button>
                    <button onclick="reportPost('{{ post.id }}')" class="w-full text-left p-2 rounded hover:bg-glass-hover">
                        <i class="fas fa-flag mr-2"></i> Report Post
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Post Content -->
    <div class="p-4">
        <p class="mb-4">{{ post.content }}</p>
        
        <!-- Post Media -->
        {% if post.image %}
        <img src="{{ post.image.url }}" 
             alt="Post image"
             class="w-full rounded-lg mb-4 cursor-pointer"
             onclick="openImageModal('{{ post.image.url }}')">
        {% elif post.video %}
        <video src="{{ post.video.url }}" 
               controls 
               poster="{{ post.video.thumbnail.url|default:'' }}"
               class="w-full rounded-lg mb-4"></video>
        {% endif %}
        
        <!-- Post Stats -->
        <div class="flex items-center justify-between text-sm text-muted mb-4">
            <div class="flex items-center gap-4">
                <span>
                    <i class="fas fa-heart mr-1"></i> {{ post.likes }}
                </span>
                <span>
                    <i class="fas fa-comment mr-1"></i> {{ post.comments_count }}
                </span>
                <span>
                    <i class="fas fa-share mr-1"></i> {{ post.shares }}
                </span>
            </div>
            <span>{{ post.views }} views</span>
        </div>
        
        <!-- Post Actions -->
        <div class="flex items-center justify-between border-t border-glass pt-4">
            <button onclick="likePost('{{ post.id }}')" 
                    class="flex-1 flex items-center justify-center gap-2 p-2 rounded-lg hover:bg-glass-hover">
                {% if post.id in liked_posts %}
                <i class="fas fa-heart text-accent-primary"></i>
                <span class="text-accent-primary">Liked</span>
                {% else %}
                <i class="far fa-heart"></i>
                <span>Like</span>
                {% endif %}
            </button>
            
            <a href="{% url 'post_detail' post.id %}" 
               class="flex-1 flex items-center justify-center gap-2 p-2 rounded-lg hover:bg-glass-hover">
                <i class="far fa-comment"></i>
                <span>Comment</span>
            </a>
            
            <button onclick="sharePost('{{ post.id }}')" 
                    class="flex-1 flex items-center justify-center gap-2 p-2 rounded-lg hover:bg-glass-hover">
                <i class="far fa-share-square"></i>
                <span>Share</span>
            </button>
        </div>
    </div>
</div>

<script>
function togglePostMenu(postId) {
    const menu = document.getElementById(`post-menu-${postId}`);
    menu.classList.toggle('hidden');
}

// Close menu when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('[onclick^="togglePostMenu"]')) {
        document.querySelectorAll('[id^="post-menu-"]').forEach(menu => {
            menu.classList.add('hidden');
        });
    }
});

async function likePost(postId) {
    try {
        const response = await fetch(`/post/${postId}/interact/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const likeButton = event.target.closest('button');
            const heartIcon = likeButton.querySelector('i');
            const likeText = likeButton.querySelector('span');
            
            if (data.is_active) {
                heartIcon.className = 'fas fa-heart text-accent-primary';
                likeText.textContent = 'Liked';
                likeText.className = 'text-accent-primary';
            } else {
                heartIcon.className = 'far fa-heart';
                likeText.textContent = 'Like';
                likeText.className = '';
            }
            
            // Update like count
            const likeCount = document.querySelector(`[data-post="${postId}"] .like-count`);
            if (likeCount) {
                likeCount.textContent = data.likes_count;
            }
        }
    } catch (error) {
        console.error('Error liking post:', error);
    }
}

async function savePost(postId) {
    try {
        const response = await fetch(`/post/${postId}/interact/save/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.is_active ? 'Post saved!' : 'Post removed from saved!');
        }
    } catch (error) {
        console.error('Error saving post:', error);
    }
}

function confirmDeletePost(postId) {
    if (confirm('Are you sure you want to delete this post?')) {
        window.location.href = `/post/${postId}/delete/`;
    }
}

function archivePost(postId) {
    window.location.href = `/post/${postId}/archive/`;
}

function reportPost(postId) {
    const reason = prompt('Please enter the reason for reporting this post:');
    if (reason) {
        fetch(`/post/${postId}/interact/report/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reason: reason })
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert('Post reported. Thank you!');
              }
          });
    }
}

function sharePost(postId) {
    const url = `${window.location.origin}/post/${postId}/`;
    
    // Copy to clipboard
    navigator.clipboard.writeText(url).then(() => {
        alert('Link copied to clipboard!');
    });
    
    // Update share count
    fetch(`/post/${postId}/interact/share/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>