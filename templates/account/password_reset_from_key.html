{% extends "base_auth.html" %}
{% load i18n %}

{% block title %}Set New Password | EscortConnect{% endblock %}

{% block auth_content %}
<div class="auth-header">
    <div class="icon-large mb-3">
        <i class="fas fa-key"></i>
    </div>
    <h1 class="auth-title">Set New Password</h1>
    <p class="auth-subtitle">Create a new secure password</p>
</div>

{% if token_fail %}
<div class="alert alert-error">
    <i class="fas fa-exclamation-triangle"></i>
    <div>
        <strong>Invalid Reset Link</strong>
        <p>The password reset link was invalid, possibly because it has already been used.</p>
        <a href="{% url 'account_reset_password' %}" class="link-premium" style="display: inline-block; margin-top: 5px;">
            Request a new reset link
        </a>
    </div>
</div>
{% else %}
<!-- Reset Form -->
<form class="auth-form" method="POST" action="{{ action_url }}">
    {% csrf_token %}
    
    {% if form.non_field_errors %}
    <div class="alert alert-error">
        <i class="fas fa-exclamation-circle"></i>
        {{ form.non_field_errors }}
    </div>
    {% endif %}
    
    <!-- Password 1 -->
    <div class="form-group">
        <input type="password" 
               name="password1" 
               id="id_password1" 
               class="form-input"
               required
               minlength="8"
               placeholder=" ">
        <label for="id_password1" class="form-label">New Password</label>
        <i class="fas fa-lock input-icon"></i>
        <button type="button" class="password-toggle" data-target="id_password1">
            <i class="fas fa-eye"></i>
        </button>
    </div>
    
    <!-- Password 2 -->
    <div class="form-group">
        <input type="password" 
               name="password2" 
               id="id_password2" 
               class="form-input"
               required
               placeholder=" ">
        <label for="id_password2" class="form-label">Confirm Password</label>
        <i class="fas fa-lock input-icon"></i>
        <button type="button" class="password-toggle" data-target="id_password2">
            <i class="fas fa-eye"></i>
        </button>
    </div>
    
    <!-- Password Strength -->
    <div class="password-strength mb-3">
        <div class="strength-bar">
            <div class="strength-fill" id="strengthFill"></div>
        </div>
        <div class="strength-text" id="strengthText">Password strength: Weak</div>
    </div>
    
    <!-- Submit -->
    <button type="submit" class="btn-primary">
        <i class="fas fa-save"></i>
        Change Password
    </button>
</form>

<div class="password-rules mt-3">
    <p class="rules-title">Password Requirements:</p>
    <ul class="rules-list">
        <li id="rule-length">✓ At least 8 characters</li>
        <li id="rule-upper">✓ One uppercase letter</li>
        <li id="rule-number">✓ One number</li>
        <li id="rule-special">✓ One special character</li>
    </ul>
</div>
{% endif %}

<style>
.icon-large i {
    font-size: 3rem;
    color: #ff4081;
    background: rgba(255,64,129,0.1);
}

.password-rules {
    background: rgba(255,255,255,0.03);
    padding: 15px;
    border-radius: 10px;
    margin-top: 20px;
}

.rules-title {
    font-size: 0.9rem;
    color: #fff;
    margin-bottom: 10px;
    font-weight: 500;
}

.rules-list {
    list-style: none;
    padding-left: 0;
}

.rules-list li {
    padding: 5px 0;
    padding-left: 25px;
    position: relative;
    color: #b0b0d0;
    font-size: 0.85rem;
}

.rules-list li:before {
    content: '✓';
    position: absolute;
    left: 0;
    color: #4caf50;
}

.rules-list li.invalid:before {
    content: '✗';
    color: #ff4757;
}
</style>

<script>
$(document).ready(function() {
    // Password strength checker
    $('#id_password1').on('input', function() {
        const password = $(this).val();
        const strengthFill = $('#strengthFill');
        const strengthText = $('#strengthText');
        
        // Check rules
        const hasLength = password.length >= 8;
        const hasUpper = /[A-Z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        const hasSpecial = /[^A-Za-z0-9]/.test(password);
        
        // Update rule indicators
        $('#rule-length').toggleClass('invalid', !hasLength);
        $('#rule-upper').toggleClass('invalid', !hasUpper);
        $('#rule-number').toggleClass('invalid', !hasNumber);
        $('#rule-special').toggleClass('invalid', !hasSpecial);
        
        // Calculate score
        let score = 0;
        if (hasLength) score++;
        if (hasUpper) score++;
        if (hasNumber) score++;
        if (hasSpecial) score++;
        
        const colors = ['#ff4757', '#ffa502', '#2ed573', '#1e90ff'];
        const labels = ['Very Weak', 'Weak', 'Good', 'Strong'];
        
        const width = (score * 25) + '%';
        strengthFill.css({
            'width': width,
            'background-color': colors[score] || colors[0]
        });
        strengthText.text('Password strength: ' + (labels[score] || 'Very Weak'));
        strengthText.css('color', colors[score] || colors[0]);
    });
    
    // Password confirmation check
    $('#id_password2').on('input', function() {
        const pass1 = $('#id_password1').val();
        const pass2 = $(this).val();
        
        if (pass1 && pass2 && pass1 !== pass2) {
            $(this).addClass('error');
        } else {
            $(this).removeClass('error');
        }
    });
});
</script>
{% endblock %}